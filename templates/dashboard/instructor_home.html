{% extends "base.html" %}
{% block title %}Instructor Dashboard{% endblock %}
{% block content %}

<div class="card" style="margin-bottom:16px;">
  <h2 style="margin:0 0 8px 0;">Instructor Dashboard</h2>
  <p style="margin:0;">Monitor phishing campaigns and engagement metrics.</p>
</div>

<div class="card" style="background: var(--secondary); margin-bottom:16px;">
  <form method="get" style="display:flex; gap:12px; align-items:center; margin:0;">
    <label for="campaign" style="margin:0;">Campaign</label>
    <select id="campaign" name="campaign" class="btn-light">
      {% for c in campaigns %}
        <option value="{{ c.id }}" {% if campaign and c.id == campaign.id %}selected{% endif %}>{{ c.name }}</option>
      {% endfor %}
    </select>
    <button class="btn-primary" type="submit">Load</button>
  </form>
</div>

{% if campaign %}
  <div class="card" style="margin-bottom:16px;">
    <h3 style="margin-top:0;">{{ campaign.name }} — Live Metrics</h3>
    {% if metrics %}
      <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:12px;">
        <div style="background: var(--accent1); padding:12px; border-radius:10px;">
          <div style="opacity:.9;">Recipients</div>
          <div style="font-size:28px; font-weight:700;">{{ metrics.total_recipients }}</div>
        </div>
        <div style="background: var(--accent2); padding:12px; border-radius:10px;">
          <div style="opacity:.9;">Opens / Clicks / Reports</div>
          <div style="font-size:20px; font-weight:700;">
            {{ metrics.opens }} / {{ metrics.clicks }} / {{ metrics.reports }}
          </div>
        </div>
        <div style="background: var(--light-primary); padding:12px; border-radius:10px; color:var(--text-secondary);">
          <div style="opacity:.9;">Rates</div>
          <div style="font-size:20px; font-weight:700;">
            Open {{ metrics.open_rate }}% · Click {{ metrics.click_rate }}% · Report {{ metrics.report_rate }}%
          </div>
        </div>
      </div>

      <div style="margin-top:16px;">
        {% for row in rate_rows %}
          {% with label=row.0 val=row.1 %}
          <div style="margin:6px 0; font-weight:600;">{{ label }} rate: {{ val }}%</div>
          <div style="background: rgba(255,255,255,.25); border-radius: 10px; height: 10px;">
            <div style="width: {{ val }}%; height: 10px; background: var(--primary); border-radius:10px;"></div>
          </div>
          {% endwith %}
        {% endfor %}
      </div>
    {% else %}
      <div class="alert-warning">No metrics yet — trigger events to see data.</div>
    {% endif %}
  </div>

  <div class="card">
    <h3 style="margin-top:0;">Top Recipients by Activity</h3>
    {% if top %}
      <div style="overflow:auto;">
        <table style="width:100%; border-collapse:collapse;">
          <thead>
            <tr>
              <th style="text-align:left; padding:8px;">Recipient</th>
              <th style="text-align:right; padding:8px;">Opens</th>
              <th style="text-align:right; padding:8px;">Clicks</th>
              <th style="text-align:right; padding:8px;">Reports</th>
              <th style="text-align:right; padding:8px;">Total</th>
            </tr>
          </thead>
          <tbody>
            {% for row in top %}
              <tr style="background: rgba(255,255,255,.08);">
                <td style="padding:8px;">{{ row.recipient__email }}</td>
                <td style="padding:8px; text-align:right;">{{ row.opens }}</td>
                <td style="padding:8px; text-align:right;">{{ row.clicks }}</td>
                <td style="padding:8px; text-align:right;">{{ row.reports }}</td>
                <td style="padding:8px; text-align:right;">{{ row.events }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="alert-warning">No activity yet.</div>
    {% endif %}
  </div>
{% else %}
  <div class="card"><div class="alert-warning">No campaigns found.</div></div>
{% endif %}
{% endblock %}
